# タスク: task02-01 - dev-container.sh作成

## タスク情報

| 項目 | 値 |
|------|-----|
| タスク識別子 | task02-01 |
| タスク名 | dev-container.sh作成（DooD/DinD切替・コンテナ管理） |
| 前提条件タスク | task01 |
| 並列実行可否 | 可（task02-02, task02-03と並列） |
| 推定所要時間 | 15分 |
| 優先度 | 高 |

---

## 作業環境

- **作業ディレクトリ（worktree）**: /tmp/WEB-DESIGN-001-task02-01/
- **ブランチ**: WEB-DESIGN-001-task02-01
- **対象リポジトリ**: submodules/web-design
- **重要**: 必ず上記の作業ディレクトリ内で作業を行ってください

---

## 前提条件

### 前提タスク成果物

| タスク | 成果物パス | 参照内容 |
|--------|------------|----------|
| task01 | `.devcontainer/Dockerfile` | イメージ名、ENTRYPOINT/CMD |
| task01 | `.devcontainer/scripts/start-code-server.sh` | エントリポイント名 |

### 確認事項

- [ ] task01が完了していること
- [ ] task01のコミットがcherry-pick済みであること

---

## 作業内容

### 目的

dev-processリポジトリのdev-container.shをweb-design用にカスタマイズして移植する。DooD/DinD切り替え機構、コンテナ管理（up/down/status/shell/logs）を実装する。

### 設計参照

- [design/02_interface-api-design.md](../design/02_interface-api-design.md) — dev-container.shインターフェース、環境変数、ポートマッピング、docker runパラメータ
- [design/04_process-flow-design.md](../design/04_process-flow-design.md) — upコマンドフロー、DooD/DinD状態遷移

### 実装ステップ

1. `scripts/` ディレクトリを作成
2. `scripts/dev-container.sh` を作成
3. コマンド体系を実装: `up`, `down`, `status`, `shell`, `logs`
4. DooD/DinD切り替えロジックを実装（`DOCKER_MODE` 環境変数）
5. マウント構築関数 `build_mounts()` を実装
6. コンテナ名生成ロジックを実装（`web-design-{PATH_HASH}`）
7. エラーハンドリングを実装（Docker未起動、ポート競合等）
8. 実行権限を付与

### 対象ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `scripts/dev-container.sh` | 新規作成 | DooD/DinD切替・コンテナ管理スクリプト |

---

## テスト方針

テスト戦略はE2Eのみのため、このタスクでは個別テストは作成しない。
E2Eテスト（task03）で以下を検証する:
- E2E-5: DinDモードでdocker psが実行できること
- E2E-6: DooDモードでdocker psが実行できること

### 実装時の確認

```bash
# bash構文チェック
bash -n scripts/dev-container.sh

# ヘルプ表示確認
bash scripts/dev-container.sh --help || bash scripts/dev-container.sh help

# 実行権限確認
test -x scripts/dev-container.sh
```

---

## 成果物

### 期待される出力

| 成果物 | パス | 説明 |
|--------|------|------|
| コンテナ管理スクリプト | `scripts/dev-container.sh` | up/down/status/shell/logsコマンド + DooD/DinD切替 |

---

## 完了条件

### 機能的条件

- [ ] `up` コマンドでコンテナを起動できること
- [ ] `down` コマンドでコンテナを停止・削除できること
- [ ] `status` コマンドでコンテナ状態を確認できること
- [ ] `shell` コマンドでコンテナにアタッチできること
- [ ] `logs` コマンドでコンテナログを表示できること
- [ ] `DOCKER_MODE=dind` でDinDモード起動ができること（`--privileged`、`docker-init.sh` → `start-code-server`）
- [ ] `DOCKER_MODE=dood` でDooDモード起動ができること（`--entrypoint start-code-server`、`-v docker.sock`）
- [ ] ポートマッピング `-p 8080:8080 -p 5173:5173` が設定されること
- [ ] コンテナ名が `web-design-{PATH_HASH}` 形式で生成されること
- [ ] labelに `managed-by=dev-container-sh` と `workspace-path` が設定されること
- [ ] `.gitconfig`, `.ssh`, `.claude`, `.copilot` のマウントが条件付きで追加されること
- [ ] Docker未起動時にエラーメッセージが表示されること
- [ ] スクリプトに実行権限があること

### 品質条件

- [ ] bash構文エラーがないこと（`bash -n` でチェック）
- [ ] ShellCheck警告がないこと（可能な場合）

---

## コミット

```bash
cd /tmp/WEB-DESIGN-001-task02-01/
git add -A
git status
git diff --staged

git commit -m "feat(scripts): dev-container.sh DooD/DinD切替スクリプトを作成

- up/down/status/shell/logsコマンドを実装
- DOCKER_MODE環境変数によるDooD/DinD切り替え
- コンテナ名の自動生成（web-design-{PATH_HASH}）
- .gitconfig/.ssh/.claude/.copilotの条件付きマウント

Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"

git rev-parse HEAD
```

---

## 注意事項

- **並列実行時の競合回避 (MRP-007)**: 本タスクはtask02-02, task02-03と並列実行される。編集対象は `scripts/dev-container.sh` のみであり、他タスクのファイル（`scripts/build-and-push-devcontainer.sh`, `package.json`, `src/`等）には触れないこと。worktreeを分離して作業する。
- dev-processのdev-container.shをベースに移植するが、以下を変更:
  - イメージ名: `nagasakah/web-design:latest`
  - ENTRYPOINT上書き(DooD): `--entrypoint start-code-server`
  - ポートマッピング: `-p 8080:8080 -p 5173:5173` を追加
  - マウント: `.aws` を削除、`.claude`, `.copilot` を追加
  - PROJECT_NAME: `web-design`
- DinD時もDooD時も `--privileged` を使用（設計書の通り）
