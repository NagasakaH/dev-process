# タスク: task02-02 - build-and-push-devcontainer.sh作成

## タスク情報

| 項目 | 値 |
|------|-----|
| タスク識別子 | task02-02 |
| タスク名 | build-and-push-devcontainer.sh作成 |
| 前提条件タスク | task01 |
| 並列実行可否 | 可（task02-01, task02-03と並列） |
| 推定所要時間 | 10分 |
| 優先度 | 中 |

---

## 作業環境

- **作業ディレクトリ（worktree）**: /tmp/WEB-DESIGN-001-task02-02/
- **ブランチ**: WEB-DESIGN-001-task02-02
- **対象リポジトリ**: submodules/web-design
- **重要**: 必ず上記の作業ディレクトリ内で作業を行ってください

---

## 前提条件

### 前提タスク成果物

| タスク | 成果物パス | 参照内容 |
|--------|------------|----------|
| task01 | `.devcontainer/devcontainer.json` | ビルド対象のdevcontainer設定 |
| task01 | `.devcontainer/Dockerfile` | Step 2ビルド対象 |

### 確認事項

- [ ] task01が完了していること
- [ ] task01のコミットがcherry-pick済みであること

---

## 作業内容

### 目的

devcontainerのプリビルドイメージを作成・Docker Hubにプッシュするスクリプトを作成する。2段階ビルド（devcontainer build → docker buildx build）パターンを実装する。

### 設計参照

- [design/02_interface-api-design.md](../design/02_interface-api-design.md) — build-and-push-devcontainer.shインターフェース、ビルドステップ
- [design/04_process-flow-design.md](../design/04_process-flow-design.md) — プリビルドイメージ作成フロー

### 実装ステップ

1. `scripts/build-and-push-devcontainer.sh` を作成
2. Step 1: `devcontainer build` で `nagasakah/web-design:base` イメージを作成
3. Step 2: `docker buildx build` で `nagasakah/web-design:latest` イメージを作成
4. `--no-push` オプションの実装（ローカルビルドのみ）
5. `--platform` オプションの実装（デフォルト: `linux/amd64`）
6. 各ステップのエラーハンドリング
7. 実行権限を付与

### 対象ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `scripts/build-and-push-devcontainer.sh` | 新規作成 | 2段階ビルド・プッシュスクリプト |

---

## テスト方針

テスト戦略はE2Eのみのため、このタスクでは個別テストは作成しない。
ビルド成功はE2Eテストの前提条件として検証される。

### 実装時の確認

```bash
# bash構文チェック
bash -n scripts/build-and-push-devcontainer.sh

# ヘルプ表示確認
bash scripts/build-and-push-devcontainer.sh --help 2>/dev/null || true

# 実行権限確認
test -x scripts/build-and-push-devcontainer.sh
```

---

## 成果物

### 期待される出力

| 成果物 | パス | 説明 |
|--------|------|------|
| ビルドスクリプト | `scripts/build-and-push-devcontainer.sh` | 2段階ビルド + Docker Hubプッシュ |

---

## 完了条件

### 機能的条件

- [ ] Step 1で `devcontainer build --image-name nagasakah/web-design:base --platform linux/amd64` が実行されること
- [ ] Step 2で `docker buildx build -t nagasakah/web-design:latest -f .devcontainer/Dockerfile .devcontainer` が実行されること
- [ ] `--no-push` オプション指定時にdocker pushがスキップされること
- [ ] `--platform` オプションでビルドプラットフォームを指定できること
- [ ] 各ステップでエラー時にスクリプトが停止すること（`set -e`）
- [ ] baseイメージのpush → latestイメージのpushの順序が正しいこと
- [ ] スクリプトに実行権限があること

### 品質条件

- [ ] bash構文エラーがないこと（`bash -n` でチェック）

---

## コミット

```bash
cd /tmp/WEB-DESIGN-001-task02-02/
git add -A
git status
git diff --staged

git commit -m "feat(scripts): build-and-push-devcontainer.sh プリビルドスクリプトを作成

- 2段階ビルド: devcontainer build (base) → docker buildx build (latest)
- --no-push オプションでローカルビルドのみ対応
- --platform オプションでビルドプラットフォーム指定

Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"

git rev-parse HEAD
```

---

## 注意事項

- dev-processのbuild-and-push-devcontainer.shをベースに移植
- イメージ名を `nagasakah/web-design` に変更
- Dockerfileパスを `.devcontainer/Dockerfile` に設定
- ビルドコンテキストを `.devcontainer/` に設定
