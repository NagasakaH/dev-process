# タスク: task02-01 - LogEntry + JsonLogFormatter 実装

## タスク情報

| 項目 | 値 |
|------|-----|
| タスク識別子 | task02-01 |
| タスク名 | LogEntry + JsonLogFormatter 実装 |
| 前提条件タスク | task01 |
| 並列実行可否 | 可（task02-02 と並列） |
| 推定所要時間 | 15分 |

## 作業内容

### 目的

ログエントリのデータ構造と JSON フォーマッターを実装する。

### 設計参照

- [design/02_interface-api-design.md](../design/02_interface-api-design.md) - ILogFormatter
- [design/03_data-structure-design.md](../design/03_data-structure-design.md) - LogEntry, JSON フォーマット

### 実装ステップ

1. `LogEntry` レコードクラスを作成
2. `ILogFormatter` インターフェースを作成
3. `JsonLogFormatter` を実装（System.Text.Json）
4. テストを作成・実行

### 対象ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `src/DotnetLambdaLogBase.Logging/LogEntry.cs` | 新規作成 | ログエントリデータ構造 |
| `src/DotnetLambdaLogBase.Logging/ILogFormatter.cs` | 新規作成 | フォーマッターインターフェース |
| `src/DotnetLambdaLogBase.Logging/JsonLogFormatter.cs` | 新規作成 | JSON フォーマッター実装 |
| `tests/.../JsonLogFormatterTests.cs` | 新規作成 | テスト |

## テスト方針（TDD: RED-GREEN-REFACTOR）

### RED: 失敗するテストケース

```csharp
public class JsonLogFormatterTests
{
    [Fact]
    public void Format_BasicEntry_ReturnsValidJson()
    {
        var formatter = new JsonLogFormatter();
        var entry = new LogEntry { Timestamp = DateTime.UtcNow, Level = LogLevel.Information,
            Category = "Test", Message = "Hello" };
        var json = formatter.Format(entry);
        Assert.Contains("\"level\":\"Information\"", json);
        Assert.Contains("\"message\":\"Hello\"", json);
    }

    [Fact]
    public void Format_WithException_IncludesExceptionDetail()
    {
        var formatter = new JsonLogFormatter();
        var entry = new LogEntry { Timestamp = DateTime.UtcNow, Level = LogLevel.Error,
            Category = "Test", Message = "Error", ExceptionDetail = "StackTrace..." };
        var json = formatter.Format(entry);
        Assert.Contains("\"exception\":", json);
    }

    [Fact]
    public void Format_WithProperties_SerializesProperties()
    {
        var formatter = new JsonLogFormatter();
        var entry = new LogEntry { Timestamp = DateTime.UtcNow, Level = LogLevel.Information,
            Category = "Test", Message = "Hello",
            Properties = new Dictionary<string, object> { ["key"] = "value" } };
        var json = formatter.Format(entry);
        Assert.Contains("\"properties\":", json);
    }

    [Fact]
    public void Format_NullProperties_OmitsProperties()
    {
        var formatter = new JsonLogFormatter();
        var entry = new LogEntry { Timestamp = DateTime.UtcNow, Level = LogLevel.Information,
            Category = "Test", Message = "Hello" };
        var json = formatter.Format(entry);
        var doc = JsonDocument.Parse(json);
        Assert.True(doc.RootElement.TryGetProperty("properties", out var prop) && prop.ValueKind == JsonValueKind.Null);
    }

    [Fact]
    public void Format_SpecialCharacters_EscapesCorrectly()
    {
        var formatter = new JsonLogFormatter();
        var entry = new LogEntry { Timestamp = DateTime.UtcNow, Level = LogLevel.Information,
            Category = "Test", Message = "Line1\nLine2\"quoted\"" };
        var json = formatter.Format(entry);
        Assert.DoesNotThrow(() => JsonDocument.Parse(json));
    }
}
```

## 完了条件

- [ ] LogEntry クラスが設計通り実装されていること
- [ ] JsonLogFormatter が有効な JSON を出力すること
- [ ] テスト UT-14〜UT-18 が全て通過すること
