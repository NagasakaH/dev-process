# タスク: task02-02 - LogBuffer 実装

## タスク情報

| 項目 | 値 |
|------|-----|
| タスク識別子 | task02-02 |
| タスク名 | LogBuffer 実装 |
| 前提条件タスク | task01 |
| 並列実行可否 | 可（task02-01 と並列） |
| 推定所要時間 | 10分 |

## 作業内容

### 目的

スレッドセーフなログバッファを ConcurrentQueue で実装する。

### 設計参照

- [design/03_data-structure-design.md](../design/03_data-structure-design.md) - LogBuffer

### 対象ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `src/DotnetLambdaLogBase.Logging/LogBuffer.cs` | 新規作成 | ログバッファ |
| `tests/.../LogBufferTests.cs` | 新規作成 | テスト |

## テスト方針（TDD: RED-GREEN-REFACTOR）

### RED: 失敗するテストケース

```csharp
public class LogBufferTests
{
    [Fact]
    public void Add_SingleEntry_CountIsOne()
    {
        var buffer = new LogBuffer(100);
        buffer.Add(CreateEntry());
        Assert.Equal(1, buffer.Count);
    }

    [Fact]
    public void Drain_ReturnsAllEntries_AndClearsBuffer()
    {
        var buffer = new LogBuffer(100);
        buffer.Add(CreateEntry());
        buffer.Add(CreateEntry());
        var entries = buffer.Drain();
        Assert.Equal(2, entries.Count);
        Assert.Equal(0, buffer.Count);
    }

    [Fact]
    public void Add_ExceedsMaxSize_DiscardsOldest()
    {
        var buffer = new LogBuffer(2);
        buffer.Add(CreateEntry("msg1"));
        buffer.Add(CreateEntry("msg2"));
        buffer.Add(CreateEntry("msg3"));
        var entries = buffer.Drain();
        Assert.Equal(2, entries.Count);
        Assert.Equal("msg2", entries[0].Message);
    }

    [Fact]
    public void Drain_EmptyBuffer_ReturnsEmptyList()
    {
        var buffer = new LogBuffer(100);
        var entries = buffer.Drain();
        Assert.Empty(entries);
    }

    [Fact]
    public void Clear_RemovesAllEntries()
    {
        var buffer = new LogBuffer(100);
        buffer.Add(CreateEntry());
        buffer.Clear();
        Assert.Equal(0, buffer.Count);
    }

    [Fact]
    public void Add_ConcurrentAccess_NoDataCorruption()
    {
        var buffer = new LogBuffer(10000);
        var tasks = Enumerable.Range(0, 100)
            .Select(i => Task.Run(() => buffer.Add(CreateEntry($"msg{i}"))))
            .ToArray();
        Task.WaitAll(tasks);
        Assert.Equal(100, buffer.Count);
    }

    private static LogEntry CreateEntry(string msg = "test") => new()
    {
        Timestamp = DateTime.UtcNow, Level = LogLevel.Information,
        Category = "Test", Message = msg
    };
}
```

## 完了条件

- [ ] LogBuffer が ConcurrentQueue で実装されていること
- [ ] MaxSize 超過時に最古エントリが破棄されること
- [ ] スレッドセーフであること
- [ ] テスト UT-08〜UT-13 が全て通過すること
