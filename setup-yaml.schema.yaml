# =============================================================================
# setup.yaml — JSON Schema (YAML形式)
# =============================================================================
# setup-template.yaml / issue-to-setup-yaml の出力をバリデーション可能。
# description は階層化オブジェクトと旧形式（文字列）の両方をサポート。
# =============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
title: "setup.yaml schema"
description: "開発セットアップ設定ファイルのスキーマ定義"
type: object

required:
  - task_name
  - ticket_id
  - target_repositories

additionalProperties: false

properties:
  # ---------------------------------------------------------------------------
  # task_name — タスク名（必須）
  # ---------------------------------------------------------------------------
  task_name:
    type: string
    minLength: 1
    description: "タスクの概要を記述する名前"

  # ---------------------------------------------------------------------------
  # ticket_id — チケットID（必須）
  # ---------------------------------------------------------------------------
  ticket_id:
    type: string
    minLength: 1
    description: "ブランチ名やドキュメントのベースとなるチケットID"

  # ---------------------------------------------------------------------------
  # description — タスクの説明
  # ---------------------------------------------------------------------------
  # 階層化オブジェクト（推奨）または旧形式の文字列をサポート
  description:
    oneOf:
      - $ref: "#/$defs/description_object"
      - type: string
        description: "旧形式: 自由記述の説明文（overview として扱われる）"

  # ---------------------------------------------------------------------------
  # related_repositories — 関連リポジトリ（参照用）
  # ---------------------------------------------------------------------------
  related_repositories:
    type: array
    items:
      $ref: "#/$defs/repository"
    description: "参照・調査のためにサブモジュールとして追加するリポジトリ"

  # ---------------------------------------------------------------------------
  # target_repositories — 修正対象リポジトリ（必須・1つ以上）
  # ---------------------------------------------------------------------------
  target_repositories:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/target_repository"
    description: "実際にコード変更を行うリポジトリ"

  # ---------------------------------------------------------------------------
  # options — オプション設定
  # ---------------------------------------------------------------------------
  options:
    type: object
    additionalProperties: false
    properties:
      create_design_document:
        type: boolean
        default: true
        description: "設計ドキュメントを作成するかどうか"
      design_document_dir:
        type: string
        default: "docs"
        description: "設計ドキュメントの出力先ディレクトリ"
      submodules_dir:
        type: string
        default: "submodules"
        description: "サブモジュールのディレクトリ"

# =============================================================================
# $defs — 再利用可能な定義
# =============================================================================
$defs:

  # ---------------------------------------------------------------------------
  # description_object — 階層化された説明（推奨形式）
  # ---------------------------------------------------------------------------
  description_object:
    type: object
    description: "階層化された説明（SSOT対応）"
    additionalProperties: false
    properties:
      overview:
        type: string
        description: "プロジェクトの概要"
      purpose:
        type: string
        description: "プロジェクトの目的"
      background:
        type: string
        description: "背景情報（investigationスキルが参照）"
      requirements:
        type: object
        additionalProperties: false
        properties:
          functional:
            type: array
            items:
              type: string
            description: "機能要件"
          non_functional:
            type: array
            items:
              type: string
            description: "非機能要件"
      acceptance_criteria:
        type: array
        items:
          type: string
        description: "受け入れ条件（planスキルが参照）"
      scope:
        type: array
        items:
          type: string
        description: "対象範囲"
      out_of_scope:
        type: array
        items:
          type: string
        description: "対象外"
      notes:
        type: string
        description: "補足情報"

  # ---------------------------------------------------------------------------
  # repository — リポジトリ定義（関連リポジトリ共通）
  # ---------------------------------------------------------------------------
  repository:
    type: object
    required:
      - name
      - url
    additionalProperties: false
    properties:
      name:
        type: string
        minLength: 1
        description: "リポジトリ名"
      url:
        type: string
        format: uri
        description: "リポジトリURL"
      branch:
        type: string
        description: "チェックアウトするブランチ（省略時はデフォルトブランチ）"

  # ---------------------------------------------------------------------------
  # target_repository — 修正対象リポジトリ定義
  # ---------------------------------------------------------------------------
  target_repository:
    type: object
    required:
      - name
      - url
    additionalProperties: false
    properties:
      name:
        type: string
        minLength: 1
        description: "リポジトリ名"
      url:
        type: string
        format: uri
        description: "リポジトリURL"
      branch:
        type: string
        description: "チェックアウトするブランチ"
      base_branch:
        type: string
        default: "main"
        description: "featureブランチの作成元となるブランチ"
